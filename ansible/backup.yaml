---
- name: Backup dos dados do servidor
  become: false
  hosts: minedoscrazy

  vars:
    app_dir: minedoscrazy
    app_timezone: America/Sao_Paulo

  vars_prompt:
    - name: "s3_bucket"
      prompt: "Bucket S3 onde o backup será armazenado"
      private: yes

  tasks:
    - name: Gerar timestamp
      ansible.builtin.shell: "TZ={{ app_timezone }} date +%Y%m%d-%H%M%S"
      register: timestamp

    - name: Criar backup dos dados
      block:

      - name: Criar zip do conteúdo da pasta
        become: true
        ansible.builtin.archive:
          path:
            - "{{ app_dir }}/data/minecraft/banned-ips.json"
            - "{{ app_dir }}/data/minecraft/banned-players.json"
            - "{{ app_dir }}/data/minecraft/ops.json"
            - "{{ app_dir }}/data/minecraft/usercache.json"
            - "{{ app_dir }}/data/minecraft/whitelist.json"
            - "{{ app_dir }}/data/minecraft/world"
            - "{{ app_dir }}/data/minecraft/config"
          dest: "{{ app_dir }}/data-{{ timestamp.stdout }}.zip"
          format: zip
          remove: no

      - name: Enviar backup para o S3
        amazon.aws.aws_s3:
          bucket: "{{ s3_bucket }}"
          object: "data-{{ timestamp.stdout }}.zip"
          src: "{{ app_dir }}/data-{{ timestamp.stdout }}.zip"
          mode: put
      
      - name: Salvar o nome do arquivo de backup
        ansible.builtin.shell: "echo 'data-{{ timestamp.stdout }}.zip' > ../.backup_filename"
        delegate_to: localhost

      always:
        - name: Remover arquivo zip temporário
          ansible.builtin.file:
            path: "{{ app_dir }}/data-{{ timestamp.stdout }}.zip"
            state: absent
